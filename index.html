<!-- index.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Намаз</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/transliteration@2.3.5/dist/browser/bundle.umd.min.js" defer></script>
</head>
<body class="system">
    <div id="preloader" class="preloader">
        <i class="fa-solid fa-spinner fa-spin icon"></i>
    </div>
    <div class="container" id="main-container" style="display: none;">
        <div class="header">
            <div class="location-info" id="location-info"><i class="fa-solid fa-location-arrow fa-2xs icon"></i><p>Определение местоположения...</p></div>
            <div id="date-info"></div>
            <button id="open-settings" class="settings-btn"><i class="fa-solid fa-gear icon"></i></button>
        </div>
        <div id="prayer-menu">
            <button class="prayer-btn" data-value="fajr">Фаджр</button>
            <button class="prayer-btn" data-value="dhuhr">Зухр</button>
            <button class="prayer-btn" data-value="asr">Аср</button>
            <button class="prayer-btn" data-value="maghrib">Магриб</button>
            <button class="prayer-btn" data-value="isha">Иша</button>
        </div>
        <div id="prayer-window" style="display: none;">
            <div class="header fixed-header">
                <button id="back-btn" class="back-btn"><i class="fa-solid fa-arrow-left icon"></i></button>
                <h2 id="prayer-name"></h2>
                <span id="prayer-time"></span>
            </div>
            <div id="history" class="history-center chat-area"></div>
            <div class="input-group fixed-input">
                <button id="audio-btn"><i class="fa-solid fa-microphone icon"></i></button>
                <button id="stop-btn" style="display: none;"><i class="fa-solid fa-circle-stop icon"></i></button>
                <input type="text" id="user-text" placeholder="Ваш произнесенный текст появится здесь" readonly>
            </div>
            <div id="feedback"></div>
        </div>
    </div>
    <!-- Полноэкранные настройки -->
    <div id="settings" style="display: none;">
        <div id="settings-content">
            <div class="header" id="header2" style="margin-top: 2%;">
                <h2 id="settings-title">Настройки</h2>
                <button id="close-settings" class="close-settings"><i class="fa-solid fa-xmark icon"></i></button>
            </div>
            <h2 id="language-section" style="text-align: center;">Язык</h2>
            <label id="lang-label">Язык интерфейса:</label>
            <select id="lang-select" onchange="localStorage.setItem('lang1', this.value)">
                <option value="ru">Русский</option>
                <option value="az">Азербайджанский</option>
                <option value="en">Английский</option>
            </select>
            <label id="transcription-lang-label">Язык транскрипции:</label>
            <select id="transcription-lang-select">
                <option value="latin">Латиница</option>
                <option value="cyrillic-ru">Кириллица (Русский)</option>
                <option value="cyrillic-kz">Кириллица (Казахский)</option>
            </select>
            <h2 id="volume-section" style="text-align: center;">Громкость</h2>
            <label id="error-volume-label">Громкость звука ошибки:</label>
            <input type="range" id="error-volume" min="0" max="100" value="50" step="5" style="width: 40%;">
            <input class="error-volume-shower" type="number" id="error-volume-shower" min="0" max="100">
            <script>
            const lang = (localStorage.getItem('lang1') || 'en').trim().toLowerCase();
            const range = document.getElementById('error-volume');
            const number = document.getElementById('error-volume-shower');
            const errorSoundSelect2 = document.getElementById('error-sound-select');
            number.addEventListener('input', () => {
                if (number.value > 100) {
                    number.value = 100;
                } else if (number.value < 0) {
                    number.value = 0;
                }
            });
            errorSoundSelect2.addEventListener('change', () => {
                if (errorSoundSelect2.value === 'none'){
                    document.getElementById('error-sound-preview').style.display = 'none';
                } else {
                    if (+range.value === 0) {
                        range.value = 5;
                        number.value = 5;
                    }
                    document.getElementById('error-sound-preview').style.display = 'block';
                }
            });
            // range → number
            range.addEventListener('input', () => {
                number.value = range.value;
            });

            // number → range (ввод)
            number.addEventListener('input', () => {
                range.value = number.value;
            });

            // number → range (потеря фокуса / change)
            number.addEventListener('change', () => {
                if (number.value === '') {
                    range.value = 50;
                    number.value = 50;
                }
            });

            </script>
            <div style="margin-top: 1px;"></div>
            <br><label id="mic-volume-label" >Громкость микрофона:</label>
            <input type="range" id="mic-volume" min="20" max="500" value="100" step="20" style="width: 40%;"><input type="number" id="mic-volume-shower" min="20" max="500">
            <div id="mic-level" style="width:100%; height:20px; background:#ddd; margin:10px 0; border-radius:4px; overflow:hidden;">
                <div id="level-bar" style="width:0%; height:100%; background:#4caf50; transition:width 0.1s;"></div>
            </div>
            <button id="test-mic">Тест микрофона</button>
            <h2 id="other-params-section" style="text-align: center;">Другие параметры</h2>
            <label id="asr-method-label">Метод расчета Аср:</label>
            <select id="asr-method-select">
                <option value="hanafi">Ханафитский</option>
                <option value="standard">Шафи, Малики, Ханбали</option>
            </select>
            <label id="error-sound-label">Звук ошибки:</label>
            <div class="select-group wide">
                <select id="error-sound-select" style="flex: 1;"  onchange="if (this.value === 'none'){document.getElementById('play-error-sound').disabled = true;range.disabled = true; document.getElementById('error-volume-shower').disabled = true;} else {document.getElementById('play-error-sound').disabled = false;range.disabled = false; document.getElementById('error-volume-shower').disabled = false}">
                    <option value="none">Выключить</option>
                    <option value="beep">Бип</option>
                </select>
                <button id="play-error-sound" class="play-btn"><i class="fa-solid fa-circle-play icon"></i></button>
            </div>
            <h2 id="app-view-section" style="text-align: center;">Вид приложения</h2>
            <label id="theme-label">Тема:</label>
            <select id="theme-select">
                <option value="system">Как на устройстве</option>
                <option value="light">Светлый</option>
                <option value="dark">Темный</option>
            </select>
            <label id="view-mode-label">Вид:</label>
            <select id="view-mode-select" disabled onchange="if (this.value === 'fullscreen'){document.getElementById('header2').style.marginTop = '30%'} else{document.getElementById('header2').style.marginTop = '2%'}">
                <option value="normal">Не полноэкранный</option>
                <option value="fullscreen">Полноэкранный</option>
            </select>
            <div class="toggle-label" id="transcription-toggle">
                <i class="fa-solid fa-toggle-on icon"></i>
                <span id="transcription-toggle-label">Показывать транскрипцию</span>
            </div>
            <div class="toggle-label" id="translation-toggle" style="margin-bottom: 10%;">
                <i class="fa-solid fa-toggle-on icon"></i>
                <span id="translation-toggle-label">Показывать перевод</span>
            </div>
        </div>
    </div>
    <!-- Modals -->
    <div id="geo-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <p id="geo-prompt">Разрешить использование геолокации для определения времени намаза?</p>
            <button id="geo-yes">Разрешить</button>
        </div>
    </div>
    <div id="mic-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <p id="mic-prompt">Разрешить использование микрофона для записи?</p>
            <button id="mic-yes">Разрешить</button>
        </div>
    </div>
    <div id="prayer-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="header">
                <h2 id="modal-prayer-name"></h2>
                <button id="modal-back" class="back-btn"><i class="fa-solid fa-arrow-left icon"></i></button>
            </div>
            <p id="remaining-time"></p>
            <div id="asr-method-container" style="display: none;">
                <label id="asr-method-label-modal">Метод расчета Аср:</label>
                <select id="asr-method-select-modal">
                    <option value="hanafi">Ханафитский</option>
                    <option value="standard">Шафи, Малики, Ханбали</option>
                </select>
            </div>
            <button id="continue-btn">Продолжить <i class="fa-solid fa-right-long icon"></i></button>
        </div>
    </div>
    <div id="location-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <p id="current-location"></p>
            <button id="update-location">Обновить</button>
            <button id="close-location-modal">Назад</button>
        </div>
    </div>
    <!-- sent-section removed: file-sending feature disabled -->
    <audio id="error-sound-beep" preload="auto">
        <source src="https://www.soundjay.com/buttons/sounds/beep-05.mp3" type="audio/mp3">
    </audio>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script type="module">
        import { suras } from './allSuras.js';
    </script>
    <script>
    const tg = window.Telegram?.WebApp || null;
    // alert(tg?.initDataUnsafe?.user?.id);
    if (!tg || tg !== null){
        document.getElementById('view-mode-label').textContent = 'Вид: (только в Telegram)';
    }
    if (tg || tg !== null && window.Telegram?.WebApp) {
        tg.ready();
        document.getElementById('view-mode-select').disabled = false;

        // ВАЖНО
        tg.enableClosingConfirmation();
        
        // Настройка кнопки Back
        tg.BackButton.hide();
        
        // Настройка кнопки Settings
        tg.SettingsButton.show();
        // Слушаем событие нажатия кнопки Settings
        tg.onEvent('settingsButtonClicked', () => {
            const mainContainer = document.getElementById('main-container');
            const settingsDiv = document.getElementById('settings');
            mainContainer.style.display = 'none';
            settingsDiv.style.display = 'block';
            // Скрываем кнопку Settings
            tg.SettingsButton.hide();
            // Показываем кнопку Back
            tg.BackButton.show();
        });
        
        // Делаем тг доступным глобально для других скриптов
        window.tg = tg;
        
        // Слушаем событие нажатия кнопки Back
        tg.onEvent('backButtonClicked', () => {
            const prayerWindow = document.getElementById('prayer-window');
            const settingsDiv = document.getElementById('settings');
            const mainContainer = document.getElementById('main-container');
            const prayerModal = document.getElementById('prayer-modal');
            const locationModal = document.getElementById('location-modal');
            
            // Если открыто меню молитвы
            if (prayerWindow.style.display === 'block') {
                if (typeof isRecording !== 'undefined' && isRecording) {
                    return; // Не закрываем если идет запись
                }
                prayerWindow.style.display = 'none';
                document.getElementById('prayer-menu').style.display = 'flex';
                mainContainer.classList.remove('full-screen');
                document.getElementById('history').innerHTML = '';
                document.getElementById('user-text').value = '';
                document.getElementById('feedback').style.display = 'none';
                document.getElementById('open-settings').style.display = 'block';
                document.getElementById('location-info').style.display = 'block';
                document.getElementById('date-info').style.display = 'block';
                tg.BackButton.hide();
                // Показываем кнопку Settings
                tg.SettingsButton.show();
            } 
            // Если открыты настройки
            else if (settingsDiv.style.display === 'block') {
                mainContainer.style.display = 'flex';
                settingsDiv.style.display = 'none';
                // Вызываем функции если они доступны
                if (typeof saveSettings === 'function') saveSettings();
                if (typeof stopMicTest === 'function') stopMicTest();
                if (typeof translations !== 'undefined' && typeof currentLang !== 'undefined') {
                    document.getElementById('test-mic').textContent = translations[currentLang].testMic;
                }
                tg.BackButton.hide();
                // Показываем кнопку Settings
                tg.SettingsButton.show();
            }
            // Если открыто модальное окно деталей намаза
            else if (prayerModal.style.display === 'flex') {
                clearInterval(prayerModalInterval);
                prayerModal.style.display = 'none';
                tg.BackButton.hide();
                // Показываем кнопку Settings
                tg.SettingsButton.show();
            }
            // Если открыто модальное окно локации
            else if (locationModal.style.display === 'flex') {
                locationModal.style.display = 'none';
                tg.BackButton.hide();
                // Показываем кнопку Settings
                tg.SettingsButton.show();
            }
        });

        // Обработчик события fullscreen_changed
        tg.onEvent('fullscreen_changed', (is_fullscreen) => {
            const mode = is_fullscreen ? 'fullscreen' : 'normal';
            const viewModeSelect = document.getElementById('view-mode-select');
            if (viewModeSelect) {
                viewModeSelect.value = mode;
            }
            // Сохраняем в localStorage
            const settings = JSON.parse(localStorage.getItem('namazSettings')) || {};
            settings.viewMode = mode;
            localStorage.setItem('namazSettings', JSON.stringify(settings));
        });

        // Обработчик события fullscreen_failed
        tg.onEvent('fullscreen_failed', (error) => {
            console.error('Fullscreen failed:', error);
            const viewModeSelect = document.getElementById('view-mode-select');
            if (viewModeSelect) {
                viewModeSelect.value = 'normal';
            }
        });
        
        // Установка блокировки ориентации в портретный режим
        if (window.Telegram?.WebApp) {
            Telegram.WebApp.request('web_app_toggle_orientation_lock', {
                locked: true
            });
        }
    }
    </script>
    <script src="https://hosted-talkify-assets.azureedge.net/js/talkify.min.js" defer></script>
    <script src="https://hosted-talkify-assets.azureedge.net/js/talkify-playlist.js" defer></script>
    <script src="https://hosted-talkify-assets.azureedge.net/js/talkify-text-highlighter.js" defer></script>
    <script>
        const micVolumeInput = document.getElementById('mic-volume-shower');

        micVolumeInput.addEventListener('input', () => {
            let value = micVolumeInput.value;

            if (value > 500) {
                micVolumeInput.value = 500;
            } else if (value < 20) {
                micVolumeInput.value = 20;
            }
        });
        window.addEventListener('load', function() {
            if (typeof talkify === 'undefined') {
                console.error('Talkify не загрузился. Используем fallback на speechSynthesis.');
                window.talkifyPlayer = {
                    playText: function(text) {
                        const u = new SpeechSynthesisUtterance(text);
                        u.lang = 'ar-SA';
                        speechSynthesis.speak(u);
                    },
                    forceVoice: function() { return this; },
                    enableTextHighlighting: function() { return this; }
                };
                return;
            }
            talkify.config = {
                remoteService: {
                    host: 'https://talkify.net',
                    apiKey: '16f5f310-26f3-4c81-8644-a945be68a3a0',
                    active: true
                },
                ui: {
                    audioControls: {
                        enabled: false
                    }
                }
            };
            window.talkifyPlayer = new talkify.TtsPlayer()
                .forceVoice({ name: "Amir" }) // Арабский голос Amir (из доступных арабских голосов Talkify)
                .enableTextHighlighting();
        });
    </script>
    <script src="translations.js" defer></script>
    <script src="words.js" defer></script>
    <script src="language.js" defer></script>
    <script src="theme.js" defer></script>
    <script src="error_sound.js" defer></script>
    <script src="transcription.js" defer></script>
    <script src="settings.js" defer></script>
    <script src="main.js" defer></script>
    <script src="permissions.js" defer></script>
    <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9bab08e818fad835',t:'MTc2Nzg2ODM4Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>